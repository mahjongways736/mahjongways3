<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Slot Mahjong</title>
  <style>
    body {
      font-family: sans-serif;
      background: #fafafa;
      text-align: center;
      padding: 20px;
    }
    .saldo-box {
      margin: 20px 0;
      font-size: 18px;
      font-weight: bold;
    }
    input, button {
      padding: 10px;
      margin: 10px;
    }
    .result {
      font-size: 24px;
      margin-top: 20px;
      color: green;
    }
  </style>
</head>
<body>
  <h1>Slot Mahjong</h1>
  <div class="saldo-box">Saldo: <span id="saldo">Rp 0</span></div>

  <input type="number" id="bet" placeholder="Masukkan taruhan (Rp)" min="400" />
  <button onclick="putar()">Putar</button>
  <div class="result" id="result"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAThDmthe18wYK8uTKS6rdp1V6yGmzSHds",
      authDomain: "slotmahjong-92afb.firebaseapp.com",
      databaseURL: "https://slotmahjong-92afb-default-rtdb.firebaseio.com",
      projectId: "slotmahjong-92afb",
      storageBucket: "slotmahjong-92afb.appspot.com",
      messagingSenderId: "700849730294",
      appId: "1:700849730294:web:17736d11c28b4d381132d7"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const encodedUser = localStorage.getItem("mahjong_user");
    if (!encodedUser) {
      alert("Silakan login terlebih dahulu!");
      window.location.href = "login.html";
    }

    const userRef = database.ref("players/" + encodedUser);

    function formatRupiah(angka) {
      return "Rp " + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function updateSaldoDisplay(saldo) {
      document.getElementById("saldo").innerText = formatRupiah(saldo);
    }

    userRef.on("value", (snapshot) => {
      const data = snapshot.val();
      if (data) {
        updateSaldoDisplay(data.saldo);
      }
    });

    function putar() {
      const bet = parseInt(document.getElementById("bet").value);
      if (isNaN(bet) || bet < 400) {
        alert("Taruhan minimal Rp400");
        return;
      }

      userRef.once("value").then((snapshot) => {
        const data = snapshot.val();
        let saldo = data.saldo;

        if (saldo < bet) {
          alert("Saldo tidak cukup");
          return;
        }

        // Sistem peluang sederhana
        const rand = Math.random();
        let menang = 0;

        if (rand < 0.1) {
          menang = bet * 5; // 10% peluang menang besar
        } else if (rand < 0.3) {
          menang = bet * 2; // 20% peluang menang kecil
        } else {
          menang = 0; // 70% kalah
        }

        const saldoBaru = saldo - bet + menang;
        userRef.update({ saldo: saldoBaru });

        // Simpan log
        const logRef = database.ref("logs/" + encodedUser);
        const newLog = {
          waktu: new Date().toISOString(),
          taruhan: bet,
          hasil: menang,
          saldo: saldoBaru
        };
        logRef.push(newLog);

        document.getElementById("result").innerText = menang > 0
          ? `Menang! Dapat ${formatRupiah(menang)}`
          : "Kalah! Coba lagi.";
      });
    }
  </script>
</body>
</html>
