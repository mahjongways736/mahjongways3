<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Slot Mahjong</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .saldo { font-size: 20px; margin-bottom: 10px; }
    button { padding: 10px 20px; margin-top: 10px; }
    .log { margin-top: 20px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAThDmthe18wYK8uTKS6rdp1V6yGmzSHds",
      authDomain: "slotmahjong-92afb.firebaseapp.com",
      databaseURL: "https://slotmahjong-92afb-default-rtdb.firebaseio.com",
      projectId: "slotmahjong-92afb",
      storageBucket: "slotmahjong-92afb.appspot.com",
      messagingSenderId: "700849730294",
      appId: "1:700849730294:web:17736d11c28b4d381132d7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body>
  <div class="saldo">Saldo: <span id="saldo">Rp0</span></div>
  <button onclick="putarSlot()">Putar Slot (-Rp100)</button>

  <div class="log">
    <h3>Riwayat</h3>
    <ul id="logList"></ul>
  </div>

  <script>
    const username = sessionStorage.getItem("mahjong_user");
    if (!username) {
      alert("Kamu belum login!");
      window.location.href = "login.html";
    }

    const saldoEl = document.getElementById("saldo");
    const logEl = document.getElementById("logList");
    const userRef = db.ref("players/" + username);

    function formatRupiah(number) {
      return 'Rp' + number.toLocaleString('id-ID');
    }

    // Ambil saldo & log dari Firebase
    function loadData() {
      userRef.once("value").then(snapshot => {
        const data = snapshot.val();
        saldoEl.textContent = formatRupiah(data?.saldo || 0);
        const logs = data?.log || [];
        logEl.innerHTML = "";
        logs.slice(-10).reverse().forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          logEl.appendChild(li);
        });
      });
    }

    function putarSlot() {
      userRef.once("value").then(snapshot => {
        const data = snapshot.val();
        let saldo = data?.saldo || 0;
        if (saldo < 100) {
          alert("Saldo tidak cukup!");
          return;
        }

        saldo -= 100;
        const hasil = Math.random() < 0.3 ? "Menang Rp500" : "Kalah";
        const menang = hasil.includes("Menang");

        if (menang) saldo += 500;

        const log = data?.log || [];
        log.push(`${new Date().toLocaleString()} - ${hasil}`);

        // Update ke Firebase
        userRef.set({ saldo: saldo, log: log }).then(() => {
          loadData();
        });
      });
    }

    // Load awal
    loadData();
  </script>
</body>
</html>
